<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <script type="text/javascript" src="./d3/d3.min.js"></script>

  <title>Dengue and Age in Lahore 2011-2012</title>

  <style>
	.legend {
	    float:bottom;
	    margin-right: 10em;
	    border-bottom-width: 15px;
	    border-top-style: solid;
	    font-size: .75em;
	    width: 10%;
	    padding-left: 0;
	    padding-right: 50;
	}
	.h3 {
		font-size: 20px;
	}


	</style>

</head>

<body>
	<h2>Young adults are most vulnerable to dengue in Lahore</h2>
	<h3>*Based on the survey results conducted in 2011-2012</h3>

	<div class = "container">

		<div id = "chart"></div>

	</div>

	<script>
		var margin = 50; //define top, left, right and bottom margins in a dict
		var width = 720;
		var height = 450;

		var legendRectSize = 18;                                  // NEW
        var legendSpacing = 4;                                    // NEW


		//load the data

		d3.json("dengue_age.json", function(error, data) {

			var data = data.filter(filterCriteria);

			function filterCriteria(d) {
			    return (d["Towns name"] != "Total no.") && (d["Towns name"] != "Prevelance(%)");
			}


			data.forEach( function(d) {
				// unary+ operator to read numerical data correctly.
				d["01-10yrs."] = +d["01-10yrs."] || 0
				d["11-20yrs."] = +d["11-20yrs."] || 0
				d["21-30yrs."] = +d["21-30yrs."] || 0
				d["31-40yrs."] = +d["31-40yrs."] || 0
				d["41-50yrs."] = +d["41-50yrs."] || 0
				d["51-60yrs."] = +d["51-60yrs."] || 0
				d["61-70yrs."] = +d["61-70yrs."] || 0
				d["71-80yrs."] = +d["71-80yrs."] || 0
				d["81-90yrs."] = +d["81-90yrs."] || 0
				d["91-100yrs."] = +d["91-100yrs."] || 0
				d["Unknown"] = +d["Unknown"] || 0
				d["Total"] = +d["Total"] || 0

			});

			data.sort(function(a, b) { return a["Total"] - b["Total"]; });
			if (error) throw error;
			dataset = data;
			makeBarChart(dataset);
			console.log(dataset);

			//console.log()
			//console.log(function (dataset) { return dataset["91-100yrs."]});
			
		});

		function makeBarChart(dataset) {

			//var sort_ = dataset.sort(function(a, b) { return b["Total no."] - a["Total no."]; });
			//console.log(sort_)

			//create a series of stacks/keys for the stacked bar chart

			var series = d3.stack()
		    .keys(["01-10yrs.", "11-20yrs.", "21-30yrs.", "31-40yrs.", "41-50yrs.", "51-60yrs.", "61-70yrs."])
		    .offset(d3.stackOffsetDiverging)
		    (dataset); //source: Mike Bostock: https://bl.ocks.org/mbostock/b5935342c6d21928111928401e2c8608



		    console.log(series)
			//add the SVG element

			var svg = d3.select("#chart")
			.append('svg') 
			.attr('width', width + margin*2)
			.attr('height', height + margin*2);

			// set the ranges of X and Y axes

			var xScale = d3.scaleBand()
			.domain(dataset.map(function (d) { return d["Towns name"]; }))
			.rangeRound([0, width])
			.paddingInner(0.4)
    		.align(0.1);

			var yScale = d3.scaleLinear()
			.domain([d3.min(series, stackMin), d3.max(series, stackMax)])
			//[d3.min(series, function (d) { return d["91-100yrs."]; }), 
				//d3.max(series, function (d) { return d["21-30yrs."];	})])
				//
			.rangeRound([0, height])
			.nice();

			//var zScale = d3.scaleOrdinal(d3.schemeCategory20); //source: Mike Bostock: https://bl.ocks.org/mbostock/b5935342c6d21928111928401e2c8608
			// change the colors

			var zScale = d3.scaleOrdinal()
    		.range(["#12719e", "#1696d2", "#e88e2d", "#46abdb", "#a2d4ec", "#73bfe2", "#a2d4ec"]);

			var g = svg.append('g')
			.attr('transform', 'translate(' + margin + ',' + (margin+10) + ')');
			//translate x and y where both of them are 25 right now
			
			var xAxis = svg.append('g')
			.attr('transform', 'translate(' + margin + ',' + (margin+10) + ')')
			.call(d3.axisTop(xScale))
			.selectAll("text")
		      //.style("text-anchor", "end")
		      .attr("dx", "15")
		      .attr("dy", "-.5em")
		      .attr("transform", "rotate(-20)" );

			var yAxis = svg.append('g')
				.attr('transform', 'translate(' + margin + ',' + (margin+10) + ')')
			.call(d3.axisLeft(yScale));

			svg.append("text")
	        //.attr("x", (width / 2))             
	        .attr("y", 0 + (margin / 2))
	        .attr("text-anchor", "middle")  
	        .style("font-size", "16px") 
	        .style("text-decoration", "underline")  
	        .text("Value vs Date Graph");

			// add the data to the bar	chart

			barchart = g.selectAll(".barchart")
				.data(series) // institutes a loop, 
				.enter().append("g")
				.attr("fill", function(d) { return zScale(d.key); })
			  .selectAll("rect")

			  .data(function(d) { return d; })
			  .enter().append("rect")
				.attr("class", "barchart") // now you're making sure that the class that you're choosing is barchartsource:
				.attr("x", function(d) { return xScale(d.data["Towns name"]); })
				.attr("width", "45")
      			.attr("y", function(d) { return yScale(d[0]); })
      			.attr("height", function(d) { return -(yScale(d[0]) - yScale(d[1])); })
      			.on("mouseover", function() { tooltip.style("display", null); })
			  .on("mouseout", function() { tooltip.style("display", "none"); })
			  .on("mousemove", function(d) {
			    var xPosition = d3.mouse(this)[0] + (margin-15);
			    var yPosition = d3.mouse(this)[1] + (margin-15);
			    tooltip.attr("transform", "translate(" + xPosition + "," + yPosition + ")");
			    //console.log(tooltip.select("text").text(d.yScale));
			    tooltip.select("text").text(d[1]-d[0])});


			function stackMin(serie) {
			  return d3.min(serie, function(d) { return d[0]; });
			}

			function stackMax(serie) {
			  return d3.max(serie, function(d) { return d[1]; });
			}


			var dataL = 5;
			var offset = 65;

			var legend = svg.selectAll('.legend')                     // NEW
	          .data(zScale.domain())                                   // NEW
	          .enter()                                                // NEW
	          .append('g')                                            // NEW
	          .attr('class', 'legend')                                // NEW
	          .attr('transform', function(d, i) { 
	             var newdataL = dataL
	             dataL +=  d.length + offset
	             return "translate(" + (newdataL)  + ")"        // NEW
	          });
	                                                // NEW

	        legend.append('rect')                                     // NEW
	          .attr('width', 15)                          // NEW
	          .attr('height', 15)
	          .attr("x", margin*3)
	            .attr("y", height)                         // NEW
	          .style('fill', zScale)                                   // NEW
	          .style('stroke', zScale);                                // NEW

	        legend.append('text')                                     // NEW
	          .attr('x', (margin)*3.38)              // NEW
	          .attr('y', height+11)              // NEW
	          .text(function(d) { return d; });                       // NEW

	         svg.append("text")             
			    .attr("transform", "translate(" + (margin*8) + " ," + margin/4 + ")")
			    .style("text-anchor", "middle")
			    .attr("font-weight", "bold")
			    .text("Neighborhood");

			svg.append("text")
			    .attr("transform", "rotate(-90)")
			    .attr("x", -margin*8)
			    .attr("y", margin/4)
			    .attr("font-weight", "bold")
			    .text("Number of people with dengue fever");

			 // prep the tooltip. source: http://bl.ocks.org/mstanaland/6100713

				var tooltip = svg.append("g")
				.attr("class", "tooltip")
				.style("display", "none");

				tooltip.append("rect")
				.attr("width", 30)
				.attr("height", 20)
				.attr("fill", "white")
				.style("opacity", 0.5);

				tooltip.append("text")
				.attr("x", 15)
				.attr("dy", "1.2em")
				.style("text-anchor", "middle")
				.attr("font-size", "12px")
				.attr("font-weight", "bold");

		};

		//things to do (in order of priority):
		//*. experiment with the mouseover
		//1. align the x axis ticks (------done)
		//2. sort the data in descending order (-------done)
		//3. add the title/subtitle/caption (or sources)
		//4. create separate pages for .script, .html and .css
	</script>
	
</body>

</html>