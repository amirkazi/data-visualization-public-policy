<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <script type="text/javascript" src="./d3/d3.min.js"></script>

  <title>Dengue and Age in Lahore 2011-2012</title>

  <style>
	.legend {
	    float:bottom;
	    margin-right: 10em;
	    border-bottom-width: 15px;
	    border-top-style: solid;
	    font-size: .75em;
	    width: 10%;
	    padding-left: 0;
	    padding-right: 50;
	</style>

</head>

<body>
	<h2>Assignment 6: Bar Chart in D3.js</h2>
	<div class = "container">

		<div id = "chart"></div>

	</div>

	<script>
		var margin = 50; //define top, left, right and bottom margins in a dict
		var width = 600;
		var height = 450;
		var legendRectSize = 18;                                  // NEW
        var legendSpacing = 4;                                    // NEW


		//load the data

		d3.json("dengue_age.json", function(error, data) {

			var data = data.filter(filterCriteria);

			function filterCriteria(d) {
			    return (d["Towns name"] != "Total no.") && (d["Towns name"] != "Prevelance(%)");
			}


			data.forEach( function(d) {
				// unary+ operator to read numerical data correctly.
				d["01-10yrs."] = +d["01-10yrs."] || 0
				d["11-20yrs."] = +d["11-20yrs."] || 0
				d["21-30yrs."] = +d["21-30yrs."] || 0
				d["31-40yrs."] = +d["31-40yrs."] || 0
				d["41-50yrs."] = +d["41-50yrs."] || 0
				d["51-60yrs."] = +d["51-60yrs."] || 0
				d["61-70yrs."] = +d["61-70yrs."] || 0
				d["71-80yrs."] = +d["71-80yrs."] || 0
				d["81-90yrs."] = +d["81-90yrs."] || 0
				d["91-100yrs."] = +d["91-100yrs."] || 0
				d["Unknown"] = +d["Unknown"] || 0
				d["Total"] = +d["Total"] || 0
			});


			if (error) throw error;
			dataset = data;
			makeBarChart(dataset);
			console.log(dataset);
			//console.log(function (dataset) { return dataset["91-100yrs."]});
			
		});

		function makeBarChart(dataset) {

			//create a series of stacks/keys for the stacked bar chart

			var series = d3.stack()
		    .keys(["01-10yrs.", "11-20yrs.", "21-30yrs.", "31-40yrs.", "41-50yrs.", "51-60yrs.", "61-70yrs.", "71-80yrs.",  "81-90yrs.", "91-100yrs."])
		    .offset(d3.stackOffsetDiverging)
		    (dataset); //source: Mike Bostock: https://bl.ocks.org/mbostock/b5935342c6d21928111928401e2c8608

		    console.log(series)
		    //console.log(dataset["01-10yrs."]);

			//add the SVG element

			var svg = d3.select("#chart")
			.append('svg') 
			.attr('width', width + margin*2)
			.attr('height', height + margin*2);

			// set the ranges of X and Y axes

			var xScale = d3.scaleBand()
			.domain(dataset.map(function (d) { return d["Towns name"]; }))
			.rangeRound([0, width])
			.paddingInner(0.1)
    		.align(0.1);

			var yScale = d3.scaleLinear()
			.domain([d3.min(series, stackMin), d3.max(series, stackMax)])
			//[d3.min(series, function (d) { return d["91-100yrs."]; }), 
				//d3.max(series, function (d) { return d["21-30yrs."];	})])
				//
			.rangeRound([0, height])
			.nice();

			var zScale = d3.scaleOrdinal(d3.schemeCategory10); //source: Mike Bostock: https://bl.ocks.org/mbostock/b5935342c6d21928111928401e2c8608

			var g = svg.append('g')
			.attr('transform', 'translate(' + margin + ',' + margin + ')');
			//translate x and y where both of them are 25 right now
			
			var xAxis = svg.append('g')
			.attr('transform', 'translate(' + margin + ',' + margin + ')')
			.call(d3.axisTop(xScale));

			var yAxis = svg.append('g')
				.attr('transform', 'translate(' + margin + ',' + (margin) + ')')
			.call(d3.axisLeft(yScale));

			// add the data to the bar	chart

			barchart = g.selectAll(".barchart")
				.data(series) // institutes a loop, 
				.enter().append("g")
				.attr("fill", function(d) { return zScale(d.key); })
			  .selectAll("rect")
			  .data(function(d) { return d; })
			  .enter().append("rect")
				.attr("class", "barchart") // now you're making sure that the class that you're choosing is barchart
				//.attr("fill", function(d) { return zScale(d.key); }) // source:
				.attr("x", function(d) { return xScale(d.data["Towns name"]); })
				.attr("width", "40")
      			.attr("y", function(d) { return yScale(d[0]); })
      			.attr("height", function(d) { return -(yScale(d[0]) - yScale(d[1])); });

      		// source: 

			function stackMin(serie) {
			  return d3.min(serie, function(d) { return d[0]; });
			}

			function stackMax(serie) {
			  return d3.max(serie, function(d) { return d[1]; });
			}


			var dataL = 0;
			var offset = 75;

			var legend = svg.selectAll('.legend')                     // NEW
	          .data(zScale.domain())                                   // NEW
	          .enter()                                                // NEW
	          .append('g')                                            // NEW
	          .attr('class', 'legend')                                // NEW
	          .attr('transform', function(d, i) { 
	             var newdataL = dataL
	             dataL +=  d.length + offset
	             return "translate(" + (newdataL)  + ")"        // NEW
	          });
	          
	                                                               // NEW

	        legend.append('rect')                                     // NEW
	          .attr('width', legendRectSize)                          // NEW
	          .attr('height', legendRectSize)
	          .attr("x", 0)
	            .attr("y", 0)                         // NEW
	          .style('fill', zScale)                                   // NEW
	          .style('stroke', zScale);                                // NEW

	        legend.append('text')                                     // NEW
	          .attr('x', 20)              // NEW
	          .attr('y', 10)              // NEW
	          .text(function(d) { return d; });                       // NEW

	         svg.append("text")             
			    .attr("transform", "translate(" + (width/2) + " ," + 10 + ")")
			    .style("text-anchor", "middle")
			    .text("Neighborhoods");

			svg.append("text")
			    .attr("transform", "rotate(-90)")
			    .attr("y", margin/3.8)
			    .attr("x",0 - (height + margin*7)/2)
			    .text("Number of people with dengue fever");

		};

		
	</script>
	
</body>
</html>